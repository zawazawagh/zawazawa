<html>
  <script src="https://aframe.io/releases/1.0.0/aframe.min.js"></script>
  <!-- <script src="https://raw.githack.com/jeromeetienne/AR.js/3.0.0/aframe/build/aframe-ar.js"></script> -->
  <script src="https://raw.githack.com/jeromeetienne/AR.js/2.2.2/aframe/build/aframe-ar.min.js"></script>
  <title>2</title>
  <script>
    AFRAME.registerComponent('navigate-on-click', {
      schema: {
        url: {
          default: ''
        }
      },
      init: function () {
        console.log("hello")
        console.log(this.el)
        var data = this.data;
        var el = this.el;
        el.addEventListener('click', function () {
          //window.location.href = data.url;
          window.open(data.url, '_blank');
        });
      }
    });

    AFRAME.registerComponent('color-randomizer', {
      init: function () {
        let colors = ["red", "green", "blue", "black", "orange", "white"]
        var el = this.el;
        el.addEventListener('click', (e) => {
          alert("tapped at ", e.clientX);
          this.el.setAttribute('color', colors[Math.floor(Math.random() * colors.length)])
        });
      }
    });
  </script>
  <script defer>
    /* a-frames bind */

var bind = function bind(fn, ctx /* , arg1, arg2 */) {
  return (function(prependedArgs) {
    return function bound() {
      // Concat the bound function arguments with those passed to original bind
      var args = prependedArgs.concat(Array.prototype.slice.call(arguments, 0));
      return fn.apply(ctx, args);
    };
  })(Array.prototype.slice.call(arguments, 2));
};

/* * * * * * * * * * * * * * * * * * * * * *
   wait until the cursor is ready and accessible
* * * * * * * * * * * * * * * * * * * * * * */
let marker = document.querySelector("[cursor]");
// console.log(marker.hasLoaded);

/* * * * * * * * * * * * * * * * * * * * * *
  replace the curosr.onMouseMove function
* * * * * * * * * * * * * * * * * * * * * * */
let cursorComponent = marker.components.cursor;
cursorComponent.onMouseMove = (function() {
  console.warn("Cursor.onMouseMove is modified");
  var direction = new THREE.Vector3();
  var mouse = new THREE.Vector2();
  var origin = new THREE.Vector3();
  var rayCasterConfig = { origin: origin, direction: direction };
  return function(evt) {
    var bounds = this.canvasBounds;
    var camera = this.el.sceneEl.camera;
    var left;
    var point;
    var top;

    camera.parent.updateMatrixWorld();

    // Calculate mouse position based on the canvas element
    if (evt.type === "touchmove" || evt.type === "touchstart") {
      // Track the first touch for simplicity.
      point = evt.touches.item(0);
    } else {
      point = evt;
    }
    // var mouseX = ret.clientX;                           // マウスのx座標
    // var mouseY = ret.clientY;                           // マウスのy座標
    // mouseX =  (mouseX / window.innerWidth)  * 2 - 1;    // -1 ～ +1 に正規化されたx座標
    // mouseY = -(mouseY / window.innerHeight) * 2 + 1;    // -1 ～ +1 に正規化されたy座標
    left = point.clientX - bounds.left;
    top = point.clientY - bounds.top;
    mouse.x = (left / bounds.width) * 2 - 1;
    mouse.y = -(top / bounds.height) * 2 + 1;
    origin.setFromMatrixPosition(camera.matrixWorld);
    let matrix = new THREE.Matrix4();

    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
      The only part we want to modify is the direction calculations
    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
    direction
      .set(mouse.x, mouse.y, 0.5)
      .applyMatrix4(matrix.getInverse(camera.projectionMatrix))
      .applyMatrix4(camera.matrixWorld)
      .sub(origin)
      .normalize();

    this.el.setAttribute("raycaster", rayCasterConfig);
    if (evt.type === "touchmove") {
      evt.preventDefault();
    }
  };
})();

/* * * * * * * * * * * * * * * * * * * * * *
               bind the context
* * * * * * * * * * * * * * * * * * * * * * */
cursorComponent.onMouseMove = bind(
  cursorComponent.onMouseMove,
  cursorComponent
);

/* * * * * * * * * * * * * * * * * * * * * *
  Update the components event listeners
* * * * * * * * * * * * * * * * * * * * * * */
cursorComponent.updateMouseEventListeners();


  </script>

  <body style="margin : 0px; overflow: hidden;">
    <a-scene embedded arjs="debugUIEnabled:false;" vr-mode-ui="enabled: false">
      <a-marker preset="hiro" cursor="rayOrigin: mouse" raycaster="objects: a-box">
        <a-box position="0 0.5 0" color-randomizer></a-box>
      </a-marker>
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: a-box">
        <a-box position="2 -0.5 -5" color-randomizer></a-box>
      </a-entity>
      <a-entity camera></a-entity>
    </a-scene>
  </body>
  <script>
    //tap point debug
    document.body.addEventListener("click", function(evt) {
      if(!evt.isTrusted) { return }
      console.log(evt.clientX);
      // console.warn("Cursor.onMouseMove is modified");
    });
  </script>
</html>
